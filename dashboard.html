<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Dashboard Pengguna</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4">

<!-- Loading -->
<div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
  <div class="text-white text-xl">Mohon Tunggu...</div>
</div>

<!-- Notifikasi -->
<div id="popupNotif" class="fixed bottom-0 left-0 right-0 bg-red-500 text-white text-center py-3 shadow hidden z-50">
  <span id="popupText"></span>
</div>

<div class="max-w-xl mx-auto bg-white rounded-xl shadow p-4 space-y-4">

  <h1 class="text-xl font-bold text-center">Dashboard Pengguna</h1>

  <!-- Tab Menu -->
  <div class="flex justify-center space-x-2">
    <button id="tabProfil" class="flex-1 py-2 border rounded bg-indigo-100">Profil</button>
    <button id="tabTask" class="flex-1 py-2 border rounded">Task</button>
  </div>

  <!-- Profil -->
  <div id="profilSection" class="space-y-3">
    <div><b>Nama:</b> <span id="pNama"></span></div>
    <div><b>Username:</b> <span id="pUsername"></span></div>
    <div><b>Email:</b> <span id="pEmail"></span></div>
    <div><b>WhatsApp:</b> <span id="pWA"></span></div>
    <div><b>Poin:</b> <span id="pPoin">0</span></div>

    <h2 class="font-bold mt-4">Ubah Password</h2>
    <input type="password" id="oldPassword" placeholder="Password Lama" class="w-full px-3 py-2 border rounded">
    <input type="password" id="newPassword" placeholder="Password Baru" class="w-full px-3 py-2 border rounded mt-2">
    <button id="btnUbahPassword" class="w-full bg-indigo-600 text-white py-2 rounded mt-2 hover:bg-indigo-700">Simpan Password</button>
    <button id="btnLogout" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">Logout</button>
  </div>

  <!-- Task -->
  <div id="taskSection" class="space-y-4 hidden">
    <button id="btnIklanAwal" class="w-full bg-yellow-500 text-white py-2 rounded hover:bg-yellow-600">Klik Iklan untuk Mulai Task</button>

    <div id="taskArea" class="hidden space-y-3">
      <p class="text-center">Isi 10 Captcha, tiap Captcha 30 detik</p>
      <div id="captchaContainer" class="space-y-2"></div>
    </div>

    <button id="btnKlaimPoin" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700 hidden">Klik Iklan untuk Klaim Poin</button>
  </div>
</div>

<script>
const SHEET_URL = 'https://script.google.com/macros/s/AKfycbzf-A7twkz_FYdZ8eqacyj8D-F1GDE3qTHN9GJvi1Ggrw5RqHTQ-qXXJ5KsH_rSzj8h/exec';

const profilSection = document.getElementById('profilSection');
const taskSection = document.getElementById('taskSection');
const tabProfil = document.getElementById('tabProfil');
const tabTask = document.getElementById('tabTask');
const loadingOverlay = document.getElementById('loadingOverlay');
const popupNotif = document.getElementById('popupNotif');
const popupText = document.getElementById('popupText');

const pNama = document.getElementById('pNama');
const pUsername = document.getElementById('pUsername');
const pEmail = document.getElementById('pEmail');
const pWA = document.getElementById('pWA');
const pPoin = document.getElementById('pPoin');

const btnUbahPassword = document.getElementById('btnUbahPassword');
const btnIklanAwal = document.getElementById('btnIklanAwal');
const taskArea = document.getElementById('taskArea');
const captchaContainer = document.getElementById('captchaContainer');
const btnKlaimPoin = document.getElementById('btnKlaimPoin');

let userData = {}; // Simpan data user di sini
let captchaCounter = 0;

tabProfil.addEventListener('click', () => {
  profilSection.classList.remove('hidden');
  taskSection.classList.add('hidden');
  tabProfil.classList.add('bg-indigo-100');
  tabTask.classList.remove('bg-indigo-100');
});

tabTask.addEventListener('click', () => {
  profilSection.classList.add('hidden');
  taskSection.classList.remove('hidden');
  tabProfil.classList.remove('bg-indigo-100');
  tabTask.classList.add('bg-indigo-100');
});

function showPopup(msg) {
  popupText.textContent = msg;
  popupNotif.classList.remove('hidden');
  setTimeout(() => popupNotif.classList.add('hidden'), 3000);
}

function loadUser() {
  loadingOverlay.classList.remove('hidden');
  const username = localStorage.getItem('username');
  if (!username) return window.location.href = 'index.html';

  fetch(SHEET_URL + `?action=detail&username=${encodeURIComponent(username)}`)
  .then(res => res.json())
  .then(data => {
    userData = data;
    pNama.textContent = data.nama;
    pUsername.textContent = data.username;
    pEmail.textContent = data.email;
    pWA.textContent = data.wa;
    pPoin.textContent = data.poin || 0;
  })
  .catch(() => showPopup('Gagal memuat data'))
  .finally(() => loadingOverlay.classList.add('hidden'));
}

btnUbahPassword.addEventListener('click', () => {
  const oldPassword = document.getElementById('oldPassword').value;
  const newPassword = document.getElementById('newPassword').value;

  if (oldPassword.length < 8) return showPopup("Password lama minimal 8 karakter");
  if (newPassword.length < 8) return showPopup("Password baru minimal 8 karakter");

  loadingOverlay.classList.remove('hidden');

  // Cek apakah password lama benar
  fetch(SHEET_URL + `?action=login&user=${encodeURIComponent(userData.username)}&password=${encodeURIComponent(oldPassword)}`)
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      // Password lama benar, lanjut ubah password
      fetch(SHEET_URL, {
        method: 'POST',
        body: JSON.stringify({ action: 'ubahPassword', username: userData.username, password: newPassword })
      })
      .then(() => {
        showPopup('Password berhasil diubah');
        document.getElementById('oldPassword').value = '';
        document.getElementById('newPassword').value = '';
      })
      .catch(() => showPopup('Gagal mengubah password'))
      .finally(() => loadingOverlay.classList.add('hidden'));
    } else {
      showPopup('Password lama salah');
      loadingOverlay.classList.add('hidden');
    }
  })
  .catch(() => {
    showPopup('Terjadi kesalahan');
    loadingOverlay.classList.add('hidden');
  });
});

btnIklanAwal.addEventListener('click', () => {
  window.open('https://linkiklan.com', '_blank');
  setTimeout(() => {
    taskArea.classList.remove('hidden');
    btnIklanAwal.classList.add('hidden');
    mulaiCaptcha();
  }, 2000);
});

function mulaiCaptcha() {
  captchaCounter = 0;
  captchaContainer.innerHTML = '';
  buatCaptcha();
}

function buatCaptcha() {
  if (captchaCounter >= 10) {
    btnKlaimPoin.classList.remove('hidden');
    return;
  }

  const capEl = document.createElement('div');
  capEl.innerHTML = `
    <div class="border p-3 flex items-center space-x-2">
      <span class="flex-1">Captcha #${captchaCounter + 1}</span>
      <button class="btnCaptcha bg-blue-600 text-white px-3 py-1 rounded">Isi</button>
    </div>
  `;
  captchaContainer.appendChild(capEl);

  const btnIsi = capEl.querySelector('.btnCaptcha');
  btnIsi.addEventListener('click', () => {
    btnIsi.disabled = true;
    btnIsi.textContent = 'Tunggu 30 detik...';
    setTimeout(() => {
      btnIsi.textContent = 'Selesai âœ…';
      captchaCounter++;
      buatCaptcha();
    }, 30000);
  });
}

btnKlaimPoin.addEventListener('click', () => {
  window.open('https://linkiklan.com', '_blank');
  setTimeout(() => {
    const poinBaru = (parseInt(userData.poin) || 0) + 10;
    loadingOverlay.classList.remove('hidden');
    fetch(SHEET_URL, {
      method: 'POST',
      body: JSON.stringify({ action: 'tambahPoin', username: userData.username, poin: poinBaru })
    })
    .then(() => {
      showPopup('Poin berhasil ditambahkan!');
      window.location.reload();
    })
    .catch(() => showPopup('Gagal klaim poin'))
    .finally(() => loadingOverlay.classList.add('hidden'));
  }, 2000);
});

  document.getElementById('btnLogout').addEventListener('click', () => {
  Swal.fire({
    title: 'Yakin Logout?',
    text: 'Kamu akan keluar dari akun ini.',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'Ya, Logout',
    cancelButtonText: 'Batal'
  }).then((result) => {
    if (result.isConfirmed) {
      localStorage.removeItem('username');
      Swal.fire({
        title: 'Berhasil Logout',
        icon: 'success',
        timer: 1500,
        showConfirmButton: false
      });
      setTimeout(() => window.location.href = 'index.html', 1500);
    }
  });
});

loadUser();
</script>

</body>
</html>
