<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Dashboard Pengguna</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4">

<!-- Loading -->
<div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
  <div class="text-white text-xl">Mohon Tunggu...</div>
</div>

<!-- Notifikasi -->
<div id="popupNotif" class="fixed bottom-0 left-0 right-0 bg-red-500 text-white text-center py-3 shadow hidden z-50">
  <span id="popupText"></span>
</div>

<div class="max-w-xl mx-auto bg-white rounded-xl shadow p-4 space-y-4">
  <h1 class="text-xl font-bold text-center">Dashboard Pengguna</h1>

  <div class="flex justify-center space-x-2">
    <button id="tabProfil" class="flex-1 py-2 border rounded bg-indigo-100">Profil</button>
    <button id="tabTask" class="flex-1 py-2 border rounded">Task</button>
  </div>

  <div id="profilSection" class="space-y-3">
    <div><b>Nama:</b> <span id="pNama"></span></div>
    <div><b>Username:</b> <span id="pUsername"></span></div>
    <div><b>Email:</b> <span id="pEmail"></span></div>
    <div><b>WhatsApp:</b> <span id="pWA"></span></div>
    <div><b>Poin:</b> <span id="pPoin">0</span></div>
    <div><b>Task Hari Ini:</b> <span id="pSesi">0</span> / 3</div>
<div id="jedaNotif" class="text-red-500 font-bold hidden"></div>

    <h2 class="font-bold mt-4">Ubah Password</h2>
    <input type="password" id="oldPassword" placeholder="Password Lama" class="w-full px-3 py-2 border rounded">
    <input type="password" id="newPassword" placeholder="Password Baru" class="w-full px-3 py-2 border rounded mt-2">
    <button id="btnUbahPassword" class="w-full bg-indigo-600 text-white py-2 rounded mt-2 hover:bg-indigo-700">Simpan Password</button>
    <button id="btnLogout" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">Logout</button>
  </div>

  <div id="taskSection" class="space-y-4 hidden">
    <button id="btnIklanAwal" class="w-full bg-yellow-500 text-white py-2 rounded hover:bg-yellow-600">Klik Iklan untuk Mulai Task</button>
    <div id="taskArea" class="hidden space-y-3">
      <p class="text-center">Isi 100 Captcha, tiap Captcha 30 detik</p>
      <div id="captchaContainer" class="space-y-2"></div>
    </div>
  </div>
</div>

<script>
const SHEET_URL = 'https://script.google.com/macros/s/AKfycbzf-A7twkz_FYdZ8eqacyj8D-F1GDE3qTHN9GJvi1Ggrw5RqHTQ-qXXJ5KsH_rSzj8h/exec';

const profilSection = document.getElementById('profilSection');
const taskSection = document.getElementById('taskSection');
const tabProfil = document.getElementById('tabProfil');
const tabTask = document.getElementById('tabTask');
const loadingOverlay = document.getElementById('loadingOverlay');
const popupNotif = document.getElementById('popupNotif');
const popupText = document.getElementById('popupText');

const pNama = document.getElementById('pNama');
const pUsername = document.getElementById('pUsername');
const pEmail = document.getElementById('pEmail');
const pWA = document.getElementById('pWA');
const pPoin = document.getElementById('pPoin');
const pSesi = document.getElementById('pSesi');
const jedaNotif = document.getElementById('jedaNotif');

const btnUbahPassword = document.getElementById('btnUbahPassword');
const btnIklanAwal = document.getElementById('btnIklanAwal');
const taskArea = document.getElementById('taskArea');
const captchaContainer = document.getElementById('captchaContainer');
const btnKlaimPoin = document.getElementById('btnKlaimPoin');

const AUDIO_BENAR = new Audio('https://cdn.pixabay.com/download/audio/2022/03/10/audio_9e0f6832f7.mp3');
const AUDIO_SALAH = new Audio('https://cdn.pixabay.com/download/audio/2022/03/15/audio_ea53cda789.mp3');

let userData = {};
let captchaCounter = 0;
let captchaCorrect = 0;
let sesi = parseInt(localStorage.getItem('sesiHariIni') || 0);
let isTaskLocked = false;

tabProfil.addEventListener('click', () => {
  profilSection.classList.remove('hidden');
  taskSection.classList.add('hidden');
  tabProfil.classList.add('bg-indigo-100');
  tabTask.classList.remove('bg-indigo-100');
});

tabTask.addEventListener('click', () => {
  profilSection.classList.add('hidden');
  taskSection.classList.remove('hidden');
  tabProfil.classList.remove('bg-indigo-100');
  tabTask.classList.add('bg-indigo-100');
});

function showPopup(msg) {
  popupText.textContent = msg;
  popupNotif.classList.remove('hidden');
  setTimeout(() => popupNotif.classList.add('hidden'), 3000);
}

function loadUser() {
  loadingOverlay.classList.remove('hidden');
  const username = localStorage.getItem('username');
  if (!username) return window.location.href = 'index.html';

  fetch(SHEET_URL + `?action=detail&username=${encodeURIComponent(username)}`)
  .then(res => res.json())
  .then(data => {
    userData = data;
    pNama.textContent = data.nama;
    pUsername.textContent = data.username;
    pEmail.textContent = data.email;
    pWA.textContent = data.wa;
    pPoin.textContent = data.poin || 0;
    pSesi.textContent = sesi;
    cekTimerJeda();
  })
  .catch(() => showPopup('Gagal memuat data'))
  .finally(() => loadingOverlay.classList.add('hidden'));
}

btnUbahPassword.addEventListener('click', () => {
  const oldPassword = document.getElementById('oldPassword').value;
  const newPassword = document.getElementById('newPassword').value;

  if (oldPassword.length < 8) return showPopup("Password lama minimal 8 karakter");
  if (newPassword.length < 8) return showPopup("Password baru minimal 8 karakter");

  loadingOverlay.classList.remove('hidden');
  fetch(SHEET_URL + `?action=login&user=${encodeURIComponent(userData.username)}&password=${encodeURIComponent(oldPassword)}`)
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      fetch(SHEET_URL, {
        method: 'POST',
        body: JSON.stringify({ action: 'ubahPassword', username: userData.username, password: newPassword })
      })
      .then(() => {
        showPopup('Password berhasil diubah');
        document.getElementById('oldPassword').value = '';
        document.getElementById('newPassword').value = '';
      })
      .catch(() => showPopup('Gagal mengubah password'))
      .finally(() => loadingOverlay.classList.add('hidden'));
    } else {
      showPopup('Password lama salah');
      loadingOverlay.classList.add('hidden');
    }
  })
  .catch(() => {
    showPopup('Terjadi kesalahan');
    loadingOverlay.classList.add('hidden');
  });
});

btnIklanAwal.addEventListener('click', () => {
  if (isTaskLocked) return Swal.fire('Task Terkunci', 'Tunggu waktu jeda selesai.', 'info');
  window.open('https://linkiklan.com', '_blank');
  setTimeout(() => {
    taskArea.classList.remove('hidden');
    btnIklanAwal.classList.add('hidden');
    mulaiCaptcha();
  }, 2000);
});

function mulaiCaptcha() {
  captchaCounter = 0;
  captchaCorrect = 0;
  captchaContainer.innerHTML = '';
  buatCaptcha();
}

function buatCaptcha() {
  if (captchaCounter >= 100) {
    selesaiTask();
    return;
  }
  
  const val = Math.random().toString(36).substr(2, 5).toUpperCase();
  const capEl = document.createElement('div');
  capEl.innerHTML = `
    <div class="border p-3 space-y-2">
      <div class="font-bold">Captcha #${captchaCounter + 1}: ${val}</div>
      <input type="text" class="w-full px-3 py-2 border rounded" placeholder="Masukkan Captcha">
      <div class="w-full bg-gray-300 h-2 rounded">
        <div class="h-2 bg-green-500 rounded" id="progressBar"></div>
      </div>
      <button class="w-full bg-blue-600 text-white py-2 rounded mt-2">Kirim</button>
    </div>
  `;
  captchaContainer.appendChild(capEl);

  const input = capEl.querySelector('input');
  const btn = capEl.querySelector('button');
  const bar = capEl.querySelector('#progressBar');

  let waktu = 30;
  const total = 30;
  const timer = setInterval(() => {
    waktu--;
    bar.style.width = `${(total - waktu) / total * 100}%`;
    if (waktu <= 0) {
      clearInterval(timer);
      captchaCounter++;
      buatCaptcha();
    }
  }, 1000);

  function cekJawaban() {
    clearInterval(timer);
    if (input.value.trim().toUpperCase() == val) {
      captchaCorrect++;
      tambahPoin(1);
      AUDIO_BENAR.play();
    } else {
      AUDIO_SALAH.play();
    }

    captchaCounter++;
    
    if (captchaCounter % 5 === 0 && captchaCounter < 100) {
      window.open('https://linkiklan.com', '_blank');
      tambahPoin(7);
    }
    buatCaptcha();
  }

  btn.addEventListener('click', cekJawaban);
  input.addEventListener('keydown', e => { if (e.key === 'Enter') cekJawaban(); });
}

function selesaiTask() {
  const persen = (captchaCorrect / 100) * 100;
  Swal.fire(`Selesai`, `Total Benar: ${captchaCorrect}/100 (${persen}%)`, 'info');

  if (persen < 50) {
    localStorage.setItem('lock24jam', Date.now());
    Swal.fire('Gagal', 'Kurang dari 50% benar, task terkunci 24 jam.', 'error');
  } else {
    sesi++;
    localStorage.setItem('sesiHariIni', sesi);
    pSesi.textContent = sesi;

    if (sesi >= 3) {
      localStorage.setItem('lock24jam', Date.now());
      Swal.fire('Selesai', 'Kamu sudah mencapai batas 3 sesi hari ini. Task terkunci 24 jam.', 'info');
    } else {
      localStorage.setItem('lastCaptchaTime', Date.now());
      Swal.fire('Selesai', 'Tunggu 15 menit sebelum lanjut.', 'success');
    }
  }
  window.location.reload();
}

function tambahPoin(poin) {
  const total = (parseInt(userData.poin) || 0) + poin;
  fetch(SHEET_URL, {
    method: 'POST',
    body: JSON.stringify({ action: 'tambahPoin', username: userData.username, poin: total })
  })
  .then(() => { userData.poin = total; pPoin.textContent = total; })
  .catch(() => showPopup('Gagal tambah poin'));
}

function cekTimerJeda() {
  const last = localStorage.getItem('lastCaptchaTime');
  const lock = localStorage.getItem('lock24jam');

  if (last && Date.now() - last < 15 * 60 * 1000) {
    hitungMundur(15 * 60 * 1000 - (Date.now() - last), 'Tunggu sebelum lanjut task');
  }
  if (lock && Date.now() - lock < 24 * 60 * 60 * 1000) {
    hitungMundur(24 * 60 * 60 * 1000 - (Date.now() - lock), 'Task terkunci, tunggu 24 jam');
    isTaskLocked = true;
  }
}

function hitungMundur(ms, pesan) {
  jedaNotif.classList.remove('hidden');
  const interval = setInterval(() => {
    ms -= 1000;
    const jam = Math.floor(ms / 3600000);
    const menit = Math.floor((ms % 3600000) / 60000);
    const detik = Math.floor((ms % 60000) / 1000);
    jedaNotif.textContent = `${pesan}: ${jam}j ${menit}m ${detik}d`;

    if (ms <= 0) {
      clearInterval(interval);
      window.location.reload();
    }
  }, 1000);
}

document.getElementById('btnLogout').addEventListener('click', () => {
  Swal.fire({
    title: 'Yakin Logout?',
    text: 'Kamu akan keluar dari akun ini.',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'Ya, Logout',
    cancelButtonText: 'Batal'
  }).then(result => {
    if (result.isConfirmed) {
      localStorage.removeItem('username');
      Swal.fire('Logout berhasil', '', 'success');
      setTimeout(() => window.location.href = 'index.html', 1500);
    }
  });
});

loadUser();
</script>

</body>
</html>
